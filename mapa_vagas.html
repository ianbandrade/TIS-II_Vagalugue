<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Mapa Vagas</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/forms.css">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
        integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/components/visibility.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/components/sidebar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/components/transition.js"></script>
    <script src="js/cadastro_vaga.js"></script>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

    <style>
        .map {
            height: 600px;
            width: 96%;
            margin: 2%;
        }

        /* remover para tirar icone carro e voltar para pin */
        .marker {
            background-size: 100% 100%;
            background-image: url("https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcRLkaEThpf_PL29dv17I9n-5XubneimyUPN62WtLFRkTpmT_lVS");
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <header>
        <div class="ui large top  menu">
            <div class="ui container">
                <a href="index.html" class="item">Início</a>
                <a href="lista_vagas.html" class="item">Vagas</a>
                <a href="cadastro_vaga.html" class="item">Cadastro de Vagas</a>
                <a href="mapa_vagas.html" class="active item">Mapa de Vagas</a>
                <div class="right menu">
                    <div class="item">
                        <a href="login.html" class="ui button">Login</a>
                    </div>
                    <div class="item">
                        <a href="cadastro_usuario.html" class="ui primary button">Cadastre-se</a>
                    </div>
                </div>
            </div>
        </div>

    </header>

    <main>

        <div id="map" class="map"></div>

        <script type="text/javascript">
            async function reply_click(clicked_id) {
                try {
                    $(() => {
                        $(`#modal_${clicked_id}`)
                            .modal({
                                closable: false,
                                inverted: true,
                                onApprove: async function () {

                                    let response = await $.getJSON("http://127.0.0.1:880/vagas");

                                    let nome = response.vagas[clicked_id.replace("btn_", "")]
                                        .Locatario.Nome
                                    let sobrenome = response.vagas[clicked_id.replace("btn_", "")]
                                        .Locatario.Sobrenome
                                    let indicador_vaga = response.vagas[clicked_id.replace("btn_",
                                        "")].Indicador
                                    let descricao = response.vagas[clicked_id.replace("btn_", "")]
                                        .Descricao
                                    let largura = response.vagas[clicked_id.replace("btn_", "")]
                                        .Dimensoes.Largura
                                    let comprimento = response.vagas[clicked_id.replace("btn_", "")]
                                        .Dimensoes.Comprimento
                                    let altura = response.vagas[clicked_id.replace("btn_", "")]
                                        .Dimensoes.Altura
                                    let cep = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Cep
                                    let endereco = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Endereco
                                    let numero = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Numero
                                    let bairro = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Bairro
                                    let cidade = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Cidade
                                    let estado = response.vagas[clicked_id.replace("btn_", "")]
                                        .Localizacao.Estado
                                    let foto_vaga = response.vagas[clicked_id.replace("btn_", "")]
                                        .Foto

                                    let data = {
                                        nome,
                                        sobrenome,
                                        indicador_vaga,
                                        foto_vaga,
                                        descricao,
                                        largura,
                                        comprimento,
                                        altura,
                                        cep,
                                        endereco,
                                        numero,
                                        bairro,
                                        cidade,
                                        estado
                                    };

                                    let post = await $.post("http://localhost:880/alugar", data);
                                    console.log(data);

                                },
                                onDeny: function () {
                                    // alert('Rejeitar');
                                }
                            })
                            .modal("show");
                    });
                } catch (errors) {
                    console.log(errors);
                }
            }

            mapboxgl.accessToken =
                'pk.eyJ1IjoiaWFuZ3VlbG1hbiIsImEiOiJjazJjY2JmaXcxeHN3M2hvamozNGsxazF5In0.xA8KBv93NZZAu44gw_fc3A';
            var map = new mapboxgl.Map({
                container: 'map', // container id
                style: 'mapbox://styles/mapbox/streets-v11', // stylesheet location
                center: [-43.9286357, -19.9346282], // starting position [lng, lat]
                zoom: 15 // starting zoom   
            });

            getEnderecoVagas()

            async function getEnderecoVagas() {
                let resposta = await $.getJSON("http://127.0.0.1:880/vagas");
                resposta.vagas.forEach((element, index) => {
                    e = element
                    element = element["Localizacao"]
                    let endereco = element.Numero + ", " + element.Endereco + ", " + element.Bairro + ", " +
                        element.Cidade + ", " + element.Estado + ", " + element.Cep + ", Brazil"
                    addPin(endereco, e, index)
                });
            }
            async function addPin(Endereco, Element, index) {
                await $.getJSON(
                    "https://api.mapbox.com/geocoding/v5/mapbox.places/" + Endereco +
                    ".json?country=BR&access_token=pk.eyJ1IjoiaWFuZ3VlbG1hbiIsImEiOiJjazJjY2JmaXcxeHN3M2hvamozNGsxazF5In0.xA8KBv93NZZAu44gw_fc3A",
                    function (dados) {
                        let coordenadas = dados.features[0].geometry.coordinates
                        var el = document.createElement(
                            'div'); //remover para tirar icone carro e voltar para pin
                        el.className = 'marker'; //remover para tirar icone carro e voltar para pin
                        new mapboxgl
                            .Marker() //new mapboxgl.Marker() _ remover <<<<el>>>> para tirar icone carro e voltar para pin 
                            .setLngLat(coordenadas)
                            .addTo(map)
                            .setPopup(new mapboxgl.Popup({
                                offset: 25
                            }).setHTML(
                                `<li class="cards_item">
                                <div class="card">
                                <div class="card_image"><img class="card-img" src="${Element["Foto"]}" width="220"></div>
                                <div class="card_content">
                                <h3 class="card_title">${Element["Localizacao"]["Endereco"]}, 
                                ${Element.Localizacao.Numero}</h3>
                                <p class="card_text">${Element["Descricao"]}
                                </p><h5>Dimensoes: ${Element.Dimensoes.Comprimento}m x 
                                ${Element.Dimensoes.Largura}m x ${Element.Dimensoes.Altura}m </h5>
                                <button class="btn card_btn" id="btn_${index}" onclick="reply_click(this.id)">Alugar</button>
                                </div>
                                </div>
                                </li>
                                <div class="ui test modal" id="modal_btn_${index}">
                                <div class="ui icon header">
                                <i class="user outline icon"></i>
                                </div>
                                <div class="content ui grid">
                                <section style="display: flex">
                                    <div style="flex-grow: 1">
                                    <h2>Locador: </h2>
                                    <p>Nome: ${Element["Locatario"]["Nome"]} ${Element["Locatario"]["Sobrenome"]}</p>
                                    <p>Indicador da vaga:  ${Element["Indicador"]}</p>
                                    <h2>Localização:</h2>
                                    <p>Rua: ${Element["Localizacao"]["Endereco"]}, ${Element["Localizacao"]["Numero"]}</p>
                                    <p>Bairro: ${Element["Localizacao"]["Bairro"]}</p>
                                    <p>Cidade: ${Element["Localizacao"]["Cidade"]}</p>
                                    <p>Estado: ${Element["Localizacao"]["Estado"]}</p>
                                    <h2>Dimensões:</h2>
                                    <p>Altura: ${Element["Dimensoes"]["Altura"]}m</p>
                                    <p>Largura: ${Element["Dimensoes"]["Largura"]}m</p>
                                    <p>Comprimento: ${Element["Dimensoes"]["Comprimento"]}m</p>
                                    </div>
                                    <div>
                                    <img src="https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/static/pin-s(${coordenadas[0]},${coordenadas[1]})/${coordenadas[0]},${coordenadas[1]},16,0,0/450x450?access_token=pk.eyJ1IjoiaWFuZ3VlbG1hbiIsImEiOiJjazJjY2JmaXcxeHN3M2hvamozNGsxazF5In0.xA8KBv93NZZAu44gw_fc3A">
                                    </div>
                                </section>

                                </div>
                                <div class="actions" style="text-align: center">
                                <p class="confirmacao" style="text-align: center">Confirmar aluguel da vaga?</p>
                                <div class="ui red cancel inverted button">
                                    <i class="remove icon"></i>
                                    Cancelar
                                </div>
                                <div class="ui green ok inverted button">
                                    <i class="checkmark icon"></i>
                                    Alugar
                                </div>
                                </div>
                            </div>`));
                    }
                );
            }
        </script>
    </main>

    <footer class="ui landing-image-footer inverted vertical footer segment">
        <div class="ui container">
            <div class="ui stackable inverted divided equal height stackable grid">
                <div class="four wide column">
                    <div class="ui inverted list">
                        <p class="item">Beatriz Melo</p>
                        <p class="item">Belle Nerissa </p>
                        <p class="item">Camila Campos</p>
                    </div>
                </div>
                <div class="four wide column">
                    <div class="ui inverted list">
                        <p class="item">Ian Bittencourt</p>
                        <p class="item">Ian Guelman</p>
                    </div>
                </div>
                <div class="four wide column">
                    <h3 class="ui inverted header">Páginas</h3>
                    <div class="ui inverted link list">
                        <a href="index.html" class="item">Home</a>
                        <a href="#" class="item">Locatário</a>
                        <a href="#" class="item">Locador</a>
                    </div>
                </div>
                <div class="three wide column">
                    <h3 class="ui inverted header">Codigo</h3>
                    <a href="">
                        <i class="github icon" id="github_icon"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

</body>

</html>